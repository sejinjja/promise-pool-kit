name: Publish

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run packaging check only (no npm publish)"
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Verify tag and package version match
        if: github.event_name == 'push'
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION="$(node -p "require('./package.json').version")"
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) does not match package.json version ($PKG_VERSION)."
            exit 1
          fi

      - name: Verify changelog entry exists for package version
        if: github.event_name == 'push'
        run: |
          PKG_VERSION="$(node -p "require('./package.json').version")"
          if ! grep -Fq "## ${PKG_VERSION} - " CHANGELOG.md; then
            echo "Missing changelog entry for version ${PKG_VERSION}."
            exit 1
          fi

      - name: Run full checks
        run: npm run check

      - name: Build package tarball
        id: pack
        run: |
          TARBALL="$(npm pack --json | node -e "let raw='';process.stdin.on('data',d=>raw+=d);process.stdin.on('end',()=>{const out=JSON.parse(raw);console.log(out[0].filename);});")"
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-package-${{ github.ref_name }}
          path: ${{ steps.pack.outputs.tarball }}

      - name: Verify npm token is configured
        if: github.event_name == 'push'
        run: |
          if [ -z "${NODE_AUTH_TOKEN}" ]; then
            echo "Missing NPM_TOKEN secret."
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: github.event_name == 'push'
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify published package install and runtime
        if: github.event_name == 'push'
        run: |
          PACKAGE_NAME="$(node -p "require('./package.json').name")"
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"

          for i in {1..10}; do
            PUBLISHED_VERSION="$(npm view "$PACKAGE_NAME" version 2>/dev/null || true)"
            if [ "$PUBLISHED_VERSION" = "$PACKAGE_VERSION" ]; then
              break
            fi
            echo "Waiting for $PACKAGE_NAME@$PACKAGE_VERSION to be visible on npm ($i/10)..."
            sleep 6
          done

          PUBLISHED_VERSION="$(npm view "$PACKAGE_NAME" version)"
          if [ "$PUBLISHED_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "Published version mismatch: expected $PACKAGE_VERSION, got $PUBLISHED_VERSION"
            exit 1
          fi

          TMP_DIR="$(mktemp -d)"
          pushd "$TMP_DIR" > /dev/null
          npm init -y > /dev/null 2>&1
          npm i "$PACKAGE_NAME@$PACKAGE_VERSION" --silent
          node -e "const { retry, runPool } = require('$PACKAGE_NAME'); (async () => { const r = await retry(async () => 'ok'); const p = await runPool([1, 2], async (n) => n * 2); if (r !== 'ok' || p.fulfilled.length !== 2) throw new Error('smoke failed'); console.log('smoke ok'); })();"
          popd > /dev/null

      - name: Prepare release notes from changelog
        if: github.event_name == 'push'
        run: |
          node scripts/changelog-section.mjs "${GITHUB_REF_NAME}" > RELEASE_NOTES.md

      - name: Create GitHub release
        if: github.event_name == 'push'
        run: |
          if gh release view "${GITHUB_REF_NAME}" > /dev/null 2>&1; then
            echo "Release already exists for ${GITHUB_REF_NAME}. Skipping."
          else
            gh release create "${GITHUB_REF_NAME}" --title "${GITHUB_REF_NAME}" --notes-file RELEASE_NOTES.md
          fi
        env:
          GH_TOKEN: ${{ github.token }}
