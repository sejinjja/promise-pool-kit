name: Publish

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      dry_run:
        required: true
        type: boolean
        default: true

concurrency:
  group: publish-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Validate manual run mode
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ inputs.dry_run }}" != "true" ]; then
            echo "workflow_dispatch requires dry_run=true."
            exit 1
          fi

      - name: Verify tag and package version match
        if: github.event_name == 'push'
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION="$(node -p "require('./package.json').version")"
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) does not match package.json version ($PKG_VERSION)."
            exit 1
          fi

      - name: Verify changelog entry exists for package version
        if: github.event_name == 'push'
        run: |
          PKG_VERSION="$(node -p "require('./package.json').version")"
          if ! grep -Fq "## ${PKG_VERSION} - " CHANGELOG.md; then
            echo "Missing changelog entry for version ${PKG_VERSION}."
            exit 1
          fi

      - name: Verify tag commit is in main history
        if: github.event_name == 'push'
        run: |
          git fetch --no-tags origin main --depth=200
          if ! git merge-base --is-ancestor "${GITHUB_SHA}" origin/main; then
            echo "Tag commit ${GITHUB_SHA} is not in origin/main history."
            exit 1
          fi

      - name: Run full checks
        run: npm run check

      - name: Build package tarball
        id: pack
        run: |
          TARBALL="$(npm pack --json | node -e "let raw='';process.stdin.on('data',d=>raw+=d);process.stdin.on('end',()=>{const out=JSON.parse(raw);console.log(out[0].filename);});")"
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-package-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ steps.pack.outputs.tarball }}
          if-no-files-found: error

      - name: Detect whether this version is already published
        if: github.event_name == 'push'
        id: npm_state
        run: |
          PACKAGE_NAME="$(node -p "require('./package.json').name")"
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"
          SPEC="${PACKAGE_NAME}@${PACKAGE_VERSION}"

          for i in {1..3}; do
            set +e
            VIEW_OUTPUT="$(npm view "${SPEC}" version 2>&1)"
            STATUS=$?
            set -e

            if [ $STATUS -eq 0 ]; then
              PUBLISHED_VERSION="$(printf "%s" "$VIEW_OUTPUT" | tr -d '[:space:]')"
              if [ "$PUBLISHED_VERSION" = "$PACKAGE_VERSION" ]; then
                echo "already_published=true" >> "$GITHUB_OUTPUT"
                echo "Version ${SPEC} is already published. Skipping publish step."
                exit 0
              fi
              echo "Unexpected npm view result for ${SPEC}: ${VIEW_OUTPUT}"
              exit 1
            fi

            if echo "$VIEW_OUTPUT" | grep -qiE "E404|404 Not Found|is not in this registry|No match found for version"; then
              echo "already_published=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "Transient npm view failure while checking ${SPEC} ($i/3):"
            echo "$VIEW_OUTPUT"
            sleep 3
          done

          echo "Unable to determine whether ${SPEC} is already published."
          exit 1

      - name: Verify npm token is configured
        if: github.event_name == 'push' && steps.npm_state.outputs.already_published != 'true'
        run: |
          if [ -z "${NODE_AUTH_TOKEN}" ]; then
            echo "Missing NPM_TOKEN secret."
            exit 1
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify npm token can authenticate
        if: github.event_name == 'push' && steps.npm_state.outputs.already_published != 'true'
        run: |
          for i in {1..3}; do
            set +e
            AUTH_OUTPUT="$(npm whoami --registry=https://registry.npmjs.org 2>&1)"
            STATUS=$?
            set -e

            if [ $STATUS -eq 0 ]; then
              exit 0
            fi

            if echo "$AUTH_OUTPUT" | grep -qiE "E401|ENEEDAUTH|Unable to authenticate|authentication token"; then
              echo "NPM_TOKEN authentication failed."
              echo "$AUTH_OUTPUT"
              exit 1
            fi

            echo "Transient npm auth failure ($i/3), retrying..."
            echo "$AUTH_OUTPUT"
            sleep 3
          done
          echo "NPM_TOKEN authentication failed after retries."
          exit 1
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: github.event_name == 'push' && steps.npm_state.outputs.already_published != 'true'
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify published package install and runtime
        if: github.event_name == 'push'
        run: |
          PACKAGE_NAME="$(node -p "require('./package.json').name")"
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"

          for i in {1..10}; do
            PUBLISHED_VERSION="$(npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null || true)"
            if [ "$PUBLISHED_VERSION" = "$PACKAGE_VERSION" ]; then
              break
            fi
            echo "Waiting for $PACKAGE_NAME@$PACKAGE_VERSION to be visible on npm ($i/10)..."
            sleep 6
          done

          PUBLISHED_VERSION="$(npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null || true)"
          if [ "$PUBLISHED_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "Published version not visible yet: expected $PACKAGE_VERSION, got '$PUBLISHED_VERSION'"
            exit 1
          fi

          TMP_DIR="$(mktemp -d)"
          pushd "$TMP_DIR" > /dev/null
          npm init -y > /dev/null 2>&1
          npm i "$PACKAGE_NAME@$PACKAGE_VERSION" --silent
          node -e "const { retry, runPool } = require('$PACKAGE_NAME'); (async () => { const r = await retry(async () => 'ok'); const p = await runPool([1, 2], async (n) => n * 2); if (r !== 'ok' || p.fulfilled.length !== 2) throw new Error('cjs smoke failed'); console.log('cjs smoke ok'); })();"
          node --input-type=module -e "import { retry, runPool } from '$PACKAGE_NAME'; const r = await retry(async () => 'ok'); const p = await runPool([1, 2], async (n) => n * 2); if (r !== 'ok' || p.fulfilled.length !== 2) throw new Error('esm smoke failed'); console.log('esm smoke ok');"
          popd > /dev/null

      - name: Prepare release notes from changelog
        if: github.event_name == 'push'
        run: |
          node scripts/changelog-section.mjs "${GITHUB_REF_NAME}" > RELEASE_NOTES.md

      - name: Create GitHub release
        if: github.event_name == 'push'
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          TARBALL="${{ steps.pack.outputs.tarball }}"

          if gh release view "${TAG_NAME}" > /dev/null 2>&1; then
            echo "Release already exists for ${TAG_NAME}."
            if gh release view "${TAG_NAME}" --json assets --jq '.assets[].name' | grep -Fxq "${TARBALL}"; then
              echo "Release asset ${TARBALL} already exists. Skipping upload."
            else
              gh release upload "${TAG_NAME}" "${TARBALL}" --clobber
            fi
          else
            gh release create "${TAG_NAME}" "${TARBALL}" --title "${TAG_NAME}" --notes-file RELEASE_NOTES.md
          fi
        env:
          GH_TOKEN: ${{ github.token }}
