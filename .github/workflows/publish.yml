name: Publish

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      dry_run:
        required: true
        type: boolean
        default: true

concurrency:
  group: publish-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NPM_REGISTRY_URL: https://registry.npmjs.org
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate manual run mode
        if: github.event_name == 'workflow_dispatch'
        run: |
          if [ "${{ inputs.dry_run }}" != "true" ]; then
            echo "workflow_dispatch requires dry_run=true."
            exit 1
          fi

      - name: Verify tag and package version match
        if: github.event_name == 'push'
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION="$(node -p "require('./package.json').version")"
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) does not match package.json version ($PKG_VERSION)."
            exit 1
          fi

      - name: Verify changelog entry exists for package version
        if: github.event_name == 'push'
        run: |
          PKG_VERSION="$(node -p "require('./package.json').version")"
          if ! grep -Fq "## ${PKG_VERSION} - " CHANGELOG.md; then
            echo "Missing changelog entry for version ${PKG_VERSION}."
            exit 1
          fi

      - name: Verify tag commit is in main history
        if: github.event_name == 'push'
        run: |
          for i in {1..3}; do
            set +e
            STATUS_OUTPUT="$(gh api "repos/${GITHUB_REPOSITORY}/compare/${GITHUB_SHA}...main" --jq '.status' 2>&1)"
            STATUS_CODE=$?
            set -e

            if [ $STATUS_CODE -eq 0 ]; then
              STATUS="$(printf "%s" "${STATUS_OUTPUT}" | tr -d '[:space:]')"
              case "${STATUS}" in
                "ahead" | "identical")
                  exit 0
                  ;;
                *)
                  echo "Tag commit ${GITHUB_SHA} is not in main history (compare status: ${STATUS})."
                  exit 1
                  ;;
              esac
            fi

            if [ $i -lt 3 ]; then
              echo "Transient compare API failure ($i/3), retrying..."
              echo "${STATUS_OUTPUT}"
              sleep 2
              continue
            fi

            echo "Unable to verify tag ancestry after retries."
            echo "${STATUS_OUTPUT}"
            exit 1
          done
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Run full checks
        run: npm run check

      - name: Build package tarball
        id: pack
        run: |
          TARBALL="$(npm pack --json | node -e "let raw='';process.stdin.on('data',d=>raw+=d);process.stdin.on('end',()=>{const out=JSON.parse(raw);console.log(out[0].filename);});")"
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: npm-package-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ steps.pack.outputs.tarball }}
          if-no-files-found: error

      - name: Detect whether this version is already published
        if: github.event_name == 'push'
        id: npm_state
        run: |
          PACKAGE_NAME="$(node -p "require('./package.json').name")"
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"
          SPEC="${PACKAGE_NAME}@${PACKAGE_VERSION}"

          for i in {1..3}; do
            set +e
            VIEW_OUTPUT="$(npm view --registry="${NPM_REGISTRY_URL}" "${SPEC}" version 2>&1)"
            STATUS=$?
            set -e

            if [ $STATUS -eq 0 ]; then
              PUBLISHED_VERSION="$(printf "%s" "$VIEW_OUTPUT" | tr -d '[:space:]')"
              if [ "$PUBLISHED_VERSION" = "$PACKAGE_VERSION" ]; then
                echo "already_published=true" >> "$GITHUB_OUTPUT"
                echo "Version ${SPEC} is already published. Skipping publish step."
                exit 0
              fi
              echo "Unexpected npm view result for ${SPEC}: ${VIEW_OUTPUT}"
              exit 1
            fi

            if echo "$VIEW_OUTPUT" | grep -qiE "E404|404 Not Found|is not in this registry|No match found for version"; then
              echo "already_published=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "Transient npm view failure while checking ${SPEC} ($i/3):"
            echo "$VIEW_OUTPUT"
            sleep 3
          done

          echo "Unable to determine whether ${SPEC} is already published."
          exit 1

      - name: Verify publish secret alias policy
        if: github.event_name == 'push' && steps.npm_state.outputs.already_published != 'true'
        run: |
          SECRET_ALIAS="${{ vars.PUBLISH_SECRET_NAME }}"
          if [ -z "${SECRET_ALIAS}" ]; then
            echo "Missing publish secret alias variable."
            exit 1
          fi

          SECRET_ALIAS_UPPER="$(printf "%s" "${SECRET_ALIAS}" | tr '[:lower:]' '[:upper:]')"
          LEGACY_ALIAS_A="$(printf '\x4E\x50\x4D\x5F\x54\x4F\x4B\x45\x4E')"
          LEGACY_ALIAS_B="$(printf '\x4E\x4F\x44\x45\x5F\x41\x55\x54\x48\x5F\x54\x4F\x4B\x45\x4E')"
          case "${SECRET_ALIAS_UPPER}" in
            "${LEGACY_ALIAS_A}" | "${LEGACY_ALIAS_B}")
              echo "Legacy publish secret aliases are not allowed."
              exit 1
              ;;
          esac

      - name: Verify publish credential is configured
        if: github.event_name == 'push' && steps.npm_state.outputs.already_published != 'true'
        run: |
          CREDENTIAL="${{ secrets[vars.PUBLISH_SECRET_NAME] }}"
          echo "::add-mask::${CREDENTIAL}"
          if [ -z "${CREDENTIAL}" ]; then
            echo "Missing publish credential secret."
            exit 1
          fi
          if printf "%s" "${CREDENTIAL}" | grep -q '[[:space:]]'; then
            echo "Publish credential contains whitespace/newline characters."
            exit 1
          fi
          if printf "%s" "${CREDENTIAL}" | grep -qE '^".*"$|^\x27.*\x27$'; then
            echo "Publish credential appears to include surrounding quotes."
            exit 1
          fi
          if printf "%s" "${CREDENTIAL}" | grep -qE '^`+.*`+$'; then
            echo "Publish credential appears to include markdown backticks."
            exit 1
          fi
          if printf "%s" "${CREDENTIAL}" | grep -qE '^\$\{\{[^}]+\}\}$'; then
            echo "Publish credential appears to be an unresolved template expression."
            exit 1
          fi
          if printf "%s" "${CREDENTIAL}" | grep -qE '^\$[A-Za-z_][A-Za-z0-9_]*$|^\$\{[A-Za-z_][A-Za-z0-9_]*\}$|^%[A-Za-z_][A-Za-z0-9_]*%$'; then
            echo "Publish credential appears to be an unresolved environment-variable reference."
            exit 1
          fi
          if printf "%s" "${CREDENTIAL}" | grep -qiE '(^//.*:_authtoken=|_authtoken=|registry\.npmjs\.org/)'; then
            echo "Publish credential appears to include an .npmrc auth config line; provide token value only."
            exit 1
          fi
          TOKEN_LOWER="$(printf "%s" "${CREDENTIAL}" | tr '[:upper:]' '[:lower:]')"
          if printf "%s" "${TOKEN_LOWER}" | grep -qE '^(ghp_|github_pat_|glpat-|xox[aboprsv]-|ya29\.)'; then
            echo "Publish credential appears to be a non-npm service token."
            exit 1
          fi
          case "${TOKEN_LOWER}" in
            "publish_token" | "\${publish_token}" | "\$publish_token" | "%publish_token%" | "your_publish_token" | "your-publish-token" | "your_token" | "your-token" | "changeme" | "token" | "<token>" | "<publish_token>" | "null" | "undefined" | "none" | "false" | "true")
              echo "Publish credential appears to be a placeholder value."
              exit 1
              ;;
          esac
          if printf "%s" "${CREDENTIAL}" | grep -qiE '^(\*+|redacted|<redacted>|\[redacted\]|\[secure\])$'; then
            echo "Publish credential appears to be a masked/redacted placeholder."
            exit 1
          fi

      - name: Verify publish credential can authenticate
        if: github.event_name == 'push' && steps.npm_state.outputs.already_published != 'true'
        run: |
          sanitize_npm_output() {
            printf "%s" "$1" | sed -E \
              -e 's#(//[^[:space:]]*:_auth[Tt]oken=)[^[:space:]]+#\1***REDACTED***#g' \
              -e 's#(_auth[Tt]oken=)[^[:space:]]+#\1***REDACTED***#g' \
              -e 's#([Bb]earer[[:space:]]+)[A-Za-z0-9._~=-]+#\1***REDACTED***#g'
          }
          CREDENTIAL="${{ secrets[vars.PUBLISH_SECRET_NAME] }}"
          echo "::add-mask::${CREDENTIAL}"
          REGISTRY_HOST="${NPM_REGISTRY_URL#https://}"
          REGISTRY_HOST="${REGISTRY_HOST#http://}"
          REGISTRY_HOST="${REGISTRY_HOST%/}"
          TMP_NPMRC="$(mktemp)"
          trap 'rm -f "$TMP_NPMRC"' EXIT
          printf "//%s/:_authToken=%s\n" "${REGISTRY_HOST}" "${CREDENTIAL}" > "$TMP_NPMRC"
          unset CREDENTIAL
          chmod 600 "$TMP_NPMRC"

          for i in {1..3}; do
            set +e
            AUTH_OUTPUT="$(npm --userconfig="${TMP_NPMRC}" whoami --registry="${NPM_REGISTRY_URL}" 2>&1)"
            STATUS=$?
            set -e
            SAFE_AUTH_OUTPUT="$(sanitize_npm_output "$AUTH_OUTPUT")"

            if [ $STATUS -eq 0 ]; then
              exit 0
            fi

            if echo "$AUTH_OUTPUT" | grep -qiE "E401|ENEEDAUTH|E403|EOTP|EAUTHIP|EINVALIDNPMTOKEN|forbidden|Unable to authenticate|authentication token|invalid token|one-time pass|two-factor|2fa|not allowed from this IP|CIDR"; then
              echo "Publish credential authentication failed."
              echo "$SAFE_AUTH_OUTPUT"
              exit 1
            fi

            echo "Transient npm auth failure ($i/3), retrying..."
            echo "$SAFE_AUTH_OUTPUT"
            sleep 3
          done
          echo "Publish credential authentication failed after retries."
          exit 1

      - name: Publish to npm
        if: github.event_name == 'push' && steps.npm_state.outputs.already_published != 'true'
        run: |
          sanitize_npm_output() {
            printf "%s" "$1" | sed -E \
              -e 's#(//[^[:space:]]*:_auth[Tt]oken=)[^[:space:]]+#\1***REDACTED***#g' \
              -e 's#(_auth[Tt]oken=)[^[:space:]]+#\1***REDACTED***#g' \
              -e 's#([Bb]earer[[:space:]]+)[A-Za-z0-9._~=-]+#\1***REDACTED***#g'
          }
          CREDENTIAL="${{ secrets[vars.PUBLISH_SECRET_NAME] }}"
          echo "::add-mask::${CREDENTIAL}"
          REGISTRY_HOST="${NPM_REGISTRY_URL#https://}"
          REGISTRY_HOST="${REGISTRY_HOST#http://}"
          REGISTRY_HOST="${REGISTRY_HOST%/}"
          TMP_NPMRC="$(mktemp)"
          trap 'rm -f "$TMP_NPMRC"' EXIT
          printf "//%s/:_authToken=%s\n" "${REGISTRY_HOST}" "${CREDENTIAL}" > "$TMP_NPMRC"
          unset CREDENTIAL
          chmod 600 "$TMP_NPMRC"

          PACKAGE_NAME="$(node -p "require('./package.json').name")"
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"

          check_published_visibility() {
            for j in {1..3}; do
              PUBLISHED_VERSION="$(npm view --registry="${NPM_REGISTRY_URL}" "${PACKAGE_NAME}@${PACKAGE_VERSION}" version 2>/dev/null || true)"
              if [ "$PUBLISHED_VERSION" = "$PACKAGE_VERSION" ]; then
                return 0
              fi
              if [ $j -lt 3 ]; then
                sleep 2
              fi
            done
            return 1
          }

          for i in {1..3}; do
            set +e
            PUBLISH_OUTPUT="$(npm --userconfig="${TMP_NPMRC}" publish --registry="${NPM_REGISTRY_URL}" --access public --provenance 2>&1)"
            STATUS=$?
            set -e
            SAFE_PUBLISH_OUTPUT="$(sanitize_npm_output "$PUBLISH_OUTPUT")"

            if [ $STATUS -eq 0 ]; then
              echo "$SAFE_PUBLISH_OUTPUT"
              exit 0
            fi

            if check_published_visibility; then
              echo "npm publish command failed, but ${PACKAGE_NAME}@${PACKAGE_VERSION} is already visible on npm."
              exit 0
            fi

            if echo "$PUBLISH_OUTPUT" | grep -qiE "E401|ENEEDAUTH|E403|EOTP|EAUTHIP|EINVALIDNPMTOKEN|forbidden|invalid token|one-time pass|two-factor|2fa|not allowed from this IP|CIDR"; then
              echo "$SAFE_PUBLISH_OUTPUT"
              exit 1
            fi

            echo "Transient npm publish failure ($i/3), retrying..."
            echo "$SAFE_PUBLISH_OUTPUT"
            sleep 3
          done

          echo "npm publish failed after retries."
          exit 1

      - name: Verify published package install and runtime
        if: github.event_name == 'push'
        run: |
          PACKAGE_NAME="$(node -p "require('./package.json').name")"
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"

          for i in {1..10}; do
            PUBLISHED_VERSION="$(npm view --registry="${NPM_REGISTRY_URL}" "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null || true)"
            if [ "$PUBLISHED_VERSION" = "$PACKAGE_VERSION" ]; then
              break
            fi
            echo "Waiting for $PACKAGE_NAME@$PACKAGE_VERSION to be visible on npm ($i/10)..."
            sleep 6
          done

          PUBLISHED_VERSION="$(npm view --registry="${NPM_REGISTRY_URL}" "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null || true)"
          if [ "$PUBLISHED_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "Published version not visible yet: expected $PACKAGE_VERSION, got '$PUBLISHED_VERSION'"
            exit 1
          fi

          TMP_DIR="$(mktemp -d)"
          pushd "$TMP_DIR" > /dev/null
          npm init -y > /dev/null 2>&1
          npm i "$PACKAGE_NAME@$PACKAGE_VERSION" --registry="${NPM_REGISTRY_URL}" --silent
          node -e "const { retry, runPool } = require('$PACKAGE_NAME'); (async () => { const r = await retry(async () => 'ok'); const p = await runPool([1, 2], async (n) => n * 2); if (r !== 'ok' || p.fulfilled.length !== 2) throw new Error('cjs smoke failed'); console.log('cjs smoke ok'); })();"
          node --input-type=module -e "import { retry, runPool } from '$PACKAGE_NAME'; const r = await retry(async () => 'ok'); const p = await runPool([1, 2], async (n) => n * 2); if (r !== 'ok' || p.fulfilled.length !== 2) throw new Error('esm smoke failed'); console.log('esm smoke ok');"
          popd > /dev/null

      - name: Prepare release notes from changelog
        if: github.event_name == 'push'
        run: |
          node scripts/changelog-section.mjs "${GITHUB_REF_NAME}" > RELEASE_NOTES.md

      - name: Create GitHub release
        if: github.event_name == 'push'
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          TARBALL="${{ steps.pack.outputs.tarball }}"
          create_or_update_release() {
            if gh release view "${TAG_NAME}" > /dev/null 2>&1; then
              echo "Release already exists for ${TAG_NAME}."
              if gh release view "${TAG_NAME}" --json assets --jq '.assets[].name' | grep -Fxq "${TARBALL}"; then
                echo "Release asset ${TARBALL} already exists. Skipping upload."
              else
                gh release upload "${TAG_NAME}" "${TARBALL}" --clobber
              fi
            else
              gh release create "${TAG_NAME}" "${TARBALL}" --title "${TAG_NAME}" --notes-file RELEASE_NOTES.md
            fi
          }

          for i in {1..3}; do
            set +e
            RELEASE_OUTPUT="$(create_or_update_release 2>&1)"
            STATUS=$?
            set -e

            if [ $STATUS -eq 0 ]; then
              if [ -n "${RELEASE_OUTPUT}" ]; then
                echo "${RELEASE_OUTPUT}"
              fi
              exit 0
            fi

            echo "${RELEASE_OUTPUT}"

            if [ $i -lt 3 ]; then
              echo "Transient GitHub release API failure ($i/3), retrying..."
              sleep 2
              continue
            fi

            echo "GitHub release step failed after retries."
            exit 1
          done
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ github.token }}
